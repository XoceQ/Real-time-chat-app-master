# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: CI - Run Jest & Cypress Tests

on:
  push:
    branches:
      - testing
  pull_request:
    branches:
      - testing

jobs:
  # ğŸ”¹ Tests que NO requieren MySQL
  test_with_mysql:
     runs-on: ubuntu-latest
  
    services:
    mysql:
      image: mysql:8.0
      env:
        MYSQL_ROOT_PASSWORD: rootpassword  # Se recomienda poner una contraseÃ±a
        MYSQL_DATABASE: real_time_chat_app
        MYSQL_USER: root
      ports:
        - 3306:3306
      options: >-
        --health-cmd="mysqladmin ping -h 127.0.0.1 --silent"
        --health-interval=5s
        --health-timeout=10s
        --health-retries=20

  steps:
    - name: ğŸ“¥ Clonar el repositorio
      uses: actions/checkout@v3

    - name: ğŸ—ï¸ Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20
        cache: 'npm'

    - name: ğŸ“¦ Instalar dependencias
      run: npm install

    - name: ğŸ” Verificar que MySQL estÃ¡ listo
      run: |
        for i in {30..0}; do
          if mysqladmin ping -h 127.0.0.1 --silent; then
            echo "âœ… MySQL estÃ¡ listo."
            break
          fi
          echo "â³ Esperando MySQL..."
          sleep 2
        done

    - name: ğŸš€ Iniciar servidor en segundo plano
      run: npm run dev &

    - name: â³ Esperar a que el servidor estÃ© listo
      run: |
        for i in {30..0}; do
          if curl --silent --fail http://localhost:3000; then
            echo "âœ… Servidor listo."
            break
          fi
          echo "â³ Esperando servidor..."
          sleep 2
        done

    - name: ğŸ§ª Ejecutar prueba con Jest (requiere MySQL)
      env:
        DATABASE_URL: mysql://root:rootpassword@127.0.0.1:3306/real_time_chat_app
      run: npx jest lib/tests/currentProfile.test.ts
